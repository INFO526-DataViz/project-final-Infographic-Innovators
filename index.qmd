---
title: "From Takeoff to Touchdown: Dissecting Data on Air Disasters"
subtitle: "INFO 526 - Project Final"
author: 
  - name: "Infographic Innovators - Antonio, Bharath, Eshaan, Thanoosha"
    affiliations:
      - name: "School of Information, University of Arizona"
description: "A shiny app integration with aircraft crash analysis"
format:
   html:
    code-tools: true
    code-overflow: wrap
    embed-resources: true
editor: visual
execute:
  warning: false
  echo: false
---

```{r load_packages, message=FALSE, include=FALSE}
# GETTING THE LIBRARIES
if (!require(pacman))
  install.packages(pacman)


pacman::p_load(tidyverse,
               dplyr,
               janitor,
               dlookr,
               here,
               ggpubr,
               maps,
               plotly,
               gganimate,
               MetBrewer,
               ggsci,
               scales,
               fmsb,
               gifski,
               ggimage,
               emojifont,
               magick,
               lubridate,
               patchwork,
               viridis,
               sf,
               sp,
               animation)

pacman::p_load_gh("BlakeRMills/MoMAColors")
```

```{r ggplot_setup, message=FALSE, include=FALSE}
# setting theme for ggplot2
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 14, base_family = "sans"))

# setting width of code output
options(width = 65)

# setting figure parameters for knitr
knitr::opts_chunk$set(
  fig.width = 8,        # 8" width
  fig.asp = 0.618,      # the golden ratio
  fig.retina = 1,       # dpi multiplier for displaying HTML output on retina
  fig.align = "center", # center align figures
  dpi = 200,            # higher dpi, sharper image
  message = FALSE
)
```

```{r load_dataset, include=FALSE}
# Reading the data using read_csv
flights_ntsb <- read_csv(here("data", "flight_crash_data_NTSB.csv"))
```

## Abstract

```{r remove_columns, include=FALSE}
# selecting columns which are required for our analysis
flights_ntsb <- flights_ntsb |>
  select(
    EventType, EventDate,
    City, State,
    ReportType, HighestInjuryLevel,
    FatalInjuryCount, SeriousInjuryCount,
    MinorInjuryCount, ProbableCause,
    Latitude, Longitude,
    AirCraftCategory, NumberOfEngines, 
    AirCraftDamage, WeatherCondition
  ) |>
  # cleaning column names using janitor package
  clean_names()
```

```{r data_wrangle, include=FALSE}
# Combining data from duplicated/multiple entries 
flights_ntsb <- flights_ntsb |>
  mutate(event_time = format(event_date, "%H:%M"),
         .after = event_date) |>
  mutate(
    event_date = as.Date(event_date),
    flight_phase = case_when(
      grepl("Landing", probable_cause, ignore.case = TRUE) ~ "Landing",
      grepl("Stop", probable_cause, ignore.case = TRUE) ~ "Landing",
      grepl("Approach", probable_cause, ignore.case = TRUE) ~ "Approach",
      grepl("Takeoff", probable_cause, ignore.case = TRUE) ~ "Takeoff",
      grepl("Take-off", probable_cause, ignore.case = TRUE) ~ "Takeoff",
      grepl("Maneuvering", probable_cause, ignore.case = TRUE) ~ "Maneuvering",
      grepl("Climb", probable_cause, ignore.case = TRUE) ~ "Climb",
      grepl("Descent", probable_cause, ignore.case = TRUE) ~ "Descent",
      grepl("Taxi", probable_cause, ignore.case = TRUE) ~ "Taxi",
      grepl("Cruise", probable_cause, ignore.case = TRUE) ~ "Cruise",
      grepl("Hover", probable_cause, ignore.case = TRUE) ~ "Hover",
      grepl("Standing", probable_cause, ignore.case = TRUE) ~ "Standing",
      grepl("Uncontrolled Descent", probable_cause, ignore.case = TRUE) ~ "Uncontrolled Descent",
      grepl("Emergency", probable_cause, ignore.case = TRUE) ~ "Emergency",
      grepl("Holding", probable_cause, ignore.case = TRUE) ~ "Holding",
    ),
    .after = probable_cause
  ) |>
  mutate(
    event_year = year(event_date),
    event_month = month(event_date)
  )
```

```{r timeseries_data, include=FALSE}
# Creating a dataset for the timeSeries plot
flights_ntsb_timeseries <- flights_ntsb |>
  group_by(event_year) |>
  summarise(
    total_fatalities = sum(fatal_injury_count, na.rm = TRUE),
    total_serious_injuries = sum(serious_injury_count, na.rm = TRUE),
    total_minor_injuries = sum(minor_injury_count, na.rm = TRUE)
  )
#time series plot ----
tp <-ggplot(flights_ntsb_timeseries, aes(x = event_year, y = total_fatalities)) +
  geom_line() + 
  labs(title = "Yearly Aircraft Crash Fatalities",
       x = "Year", 
       y = "Total Fatalities") +
  theme_minimal()


# Interactive plot with ploty---- total fatalities
p <- ggplot(flights_ntsb_timeseries, aes(x = event_year, y = total_fatalities)) +
  geom_line() +
  geom_text(aes(label = "✈️"), 
            vjust = -0.5, 
            hjust = 0.5, 
            size = 5)+
  labs(title = "Yearly Aircraft Crash Fatalities",
       x = "Year", 
       y = "Total Fatalities")

ggplotly(p)

# Creating Animated Plot for Total Faltalities
Image <- "images/airplane.png"  #Save Image instead of inserting emoji

# Labelling the axes and adding title to the plot for Fatalities
p <- ggplot(flights_ntsb_timeseries, 
            aes(x = event_year, 
                y = total_fatalities)) +
  geom_line() +
  geom_image(aes(image = Image), 
             size = 0.05) +  
  labs(title = "Yearly Aircraft Crash Fatalities",
       x = "Year", 
       y = "Total Fatalities") +
  theme_minimal()

# Animating the plot
animated_plot <- p +
  transition_reveal(event_year) +
  ease_aes('linear') +
  shadow_mark()

# Animating the plot
animate(animated_plot, 
        nframes = 200, 
        width = 800, 
        height = 600, 
        renderer = gifski_renderer())

# Labelling the axes and adding title to the plot for Serious Injuries
p_serious_injuries <- ggplot(flights_ntsb_timeseries, aes(x = event_year, 
                                         y = total_serious_injuries)) +
  geom_line() +
  geom_image(aes(image = Image), 
             size = 0.05) +  
  labs(title = "Yearly Aircraft Crash Serious Injuries",
       x = "Year", 
       y = "Total Serious Injuries") +
  theme_minimal()

# Animating the Aircraft serious injuries plot
animated_serious_injuries <- p_serious_injuries +
  transition_reveal(event_year) +
  ease_aes('linear') +
  shadow_mark()

animate(animated_serious_injuries, 
        nframes = 200, 
        width = 800, 
        height = 600, 
        renderer = gifski_renderer())


# Plotting a timeseries graph for total minor injuries
p_minor_injuries <- ggplot(flights_ntsb_timeseries, 
                           aes(x = event_year, 
                                       
                               y = total_minor_injuries)) +
  geom_line() +
  geom_image(aes(image = Image), size = 0.05) +  
  labs(title = "Yearly Aircraft Crash Minor Injuries",
       x = "Year", 
       y = "Total Minor Injuries") +
  theme_minimal()

# Animating the timeseries plot for total minor injuries
animated_minor_injuries <- p_minor_injuries +
  transition_reveal(event_year) +
  ease_aes('linear') +
  shadow_mark()

animate(animated_minor_injuries, 
        nframes = 200, 
        width = 800, 
        height = 600, 
        renderer = gifski_renderer())

# Reshaping the data to a longer format
long_fcdata <- flights_ntsb_timeseries |>
  pivot_longer(cols = starts_with("total_"), 
               names_to = "Category", 
               values_to = "Count")


# Static plot for  3 animations- interactive
# Time series plot with all categories
tp <- ggplot(long_fcdata, 
             aes(x = event_year, 
                 y = Count, 
                 color = Category)) +
  geom_line() +
  labs(title = "Yearly Aircraft Crash Statistics",
       x = "Year", 
       y = "Count") +
  theme_minimal()

# Interactive plot with plotly
p <- ggplot(long_fcdata, aes(x = event_year, 
                             y = Count, 
                             color = Category)) +
  geom_line() +
  geom_text(aes(label = "✈️"), 
            vjust = -0.5, 
            hjust = 0.5, 
            size = 5) +
  labs(title = "Yearly Aircraft Crash Statistics",
       x = "Year", 
       y = "Count")

ggplotly(p)
```

```{r animated_labels}
# all 3 plots with label - animated 

fcdata <- flights_ntsb_timeseries |>
  ungroup() |>
  pivot_longer(cols = starts_with("total_"), names_to = "Category", values_to = "Count") |>
  mutate(Category = case_when(Category == "total_fatalities" ~ "Fatalities",
                              Category == "total_serious_injuries" ~ "Serious Injuries",
                              Category == "total_minor_injuries" ~ "Minor Injuries"))



# Creating the animated plot
animation_fcdata <- ggplot(fcdata, 
                           aes(event_year, 
                               Count, 
                               group = Category, 
                               color = Category)) +
  geom_line(show.legend = FALSE) +
  geom_segment(aes(xend = max(event_year) + 
                     0.1, 
                   yend = Count), 
               linetype = 2, 
               colour = 'grey', 
               show.legend = FALSE) +
  geom_point(size = 2, 
             show.legend = FALSE) +
  geom_text(aes(x = max(event_year) + 0.1, 
                label = Category, 
                color = "#000000"), 
            hjust = 0, 
            show.legend = FALSE) +
  transition_reveal(event_year) +
  coord_cartesian(clip = 'off') +
  theme(plot.title = element_text(size = 20)) +
  labs(title = 'Aircraft Crash Statistics Over Time',
       y = 'Count',
       x = element_blank()) +
  theme(plot.margin = margin(5.5, 40, 5.5, 5.5))

# Animating the plot
animated_fcdata <- animate(animation_fcdata,
                           fps = 10,
                           duration = 25,
                           width = 800, height = 200,
                           renderer = gifski_renderer("images/animated_fcdata.gif"))

# Display or save the animated plot
animated_fcdata
```

![](images/animated_fcdata.gif)

```{r radarchart_data, include=FALSE}
flights_ntsb_radar <- flights_ntsb |>
  mutate(
    weather_condition = case_when(
      weather_condition == "IFR" ~ "IMC",
      weather_condition == "VFR" ~ "VMC",
      weather_condition == "Unknown" ~ "UNK",
      is.na(weather_condition) ~ "UNK",
      TRUE ~ weather_condition
    )
  ) |>
  group_by(event_month, weather_condition) |>
  summarise(
    total_crashes = n(),
    total_injuries = sum(fatal_injury_count, na.rm = TRUE) + sum(serious_injury_count, na.rm = TRUE) + sum(minor_injury_count, na.rm = TRUE)
  ) |>
  arrange(event_month)
```

```{r radar_chart, include=FALSE}
radar_trace_r1 <- flights_ntsb_radar |>
  filter(weather_condition %in% c("IMC")) |>
  pull(total_crashes)

radar_trace_r1 <-
  c(
    radar_trace_r1,
    flights_ntsb_radar |> 
      filter(weather_condition == "IMC" & event_month == 1) |> 
      pull(total_crashes)
  )

radar_trace_r2 <- flights_ntsb_radar |>
  filter(weather_condition %in% c("VMC")) |>
  pull(total_crashes)

radar_trace_r2 <-
  c(
    radar_trace_r2,
    flights_ntsb_radar |> 
      filter(weather_condition == "VMC" & event_month == 1) |> 
      pull(total_crashes)
  )

radar_theta <- c("Jan" , "Feb" , "Mar" , "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec", "Jan")
```

```{r radar_chart_plotly}
rader_chart <- plot_ly(type = 'scatterpolar',
               fill = 'toself',
               mode = 'lines+markers')

rader_chart <- rader_chart |>
  add_trace(
    r = radar_trace_r2,
    theta = radar_theta,
    name = 'VMC'
  )
rader_chart <- rader_chart |>
  add_trace(
    r = radar_trace_r1,
    theta = radar_theta,
    name = 'IMC'
  )
rader_chart <- rader_chart |>
  layout(polar = list(radialaxis = list(
    visible = T,
    range = c(0, 10500)
  )))

rader_chart
```

```{r radial_plot}
flights_ntsb_radial <- flights_ntsb |>
  group_by(flight_phase) |>
  summarise(
    total_crashes = n(),
    total_injuries = sum(fatal_injury_count, na.rm = TRUE) + sum(serious_injury_count, na.rm = TRUE) + sum(minor_injury_count, na.rm = TRUE)
  ) |>
  drop_na() |>
  arrange(desc(total_crashes))

flights_ntsb_radial <- flights_ntsb_radial |>
  slice(1:5) |>
  bind_rows(
    flights_ntsb_radial |>
      slice(-(1:5)) |>
      summarize(
        flight_phase = "Other",
        total_crashes = sum(total_crashes),
        total_injuries = sum(total_injuries)
      )
  ) |>
  mutate(flight_phase = fct_inorder(flight_phase))

flights_ntsb_radial
```

```{r radial_plot_crashes}
#| code-fold: true
#| code-summary: "Radial Bar Plot - Total Crashes"

flights_radial_bar_crashes <-
  ggplot(flights_ntsb_radial,
         aes(x = fct_rev(flight_phase), y = total_crashes, 
             fill = flight_phase)) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(hjust = 1.2, size = 4.2, 
            aes(y = 0, label = comma(total_crashes))) +
  coord_polar(theta = "y") +
  labs(
    x = NULL,
    y = NULL,
    fill = "Phase of Flight",
    title = "",
    subtitle = "",
    caption = ""
  ) +
  scale_y_continuous(
    breaks = seq(0, 27000, by = 5000),
    limits = c(0, 27000)
  ) +
  scale_x_discrete(expand = c(0.35, 0)) + 
  scale_fill_frontiers() +
  theme(
    legend.position = "bottom",
    axis.text = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank()
    ) +
  guides(
      fill = guide_legend(
        nrow = 1,
        direction = "horizontal",
        title.position = "top",
        title.hjust = 0.5,
        label.position = "bottom",
        label.hjust = 1,
        label.vjust = 1,
        label.theme = element_text(lineheight = 0.25, size = 14),
        keywidth = 1.5,
        keyheight = 0.5
      )
    )
flights_radial_bar_crashes
# remaining - titles, some texts
# interactive - plotly
# animate - plotly by years or gganimate bar growth
# sources:
# gganimate - https://r-graph-gallery.com/288-animated-barplot-transition.html
# ploty - https://plotly.com/r/animations/
```

```{r radial_plot_injuries}
#| code-fold: true
#| code-summary: "Radial Bar Plot - Total Injuries"

flights_radial_bar_injuries <-
  ggplot(flights_ntsb_radial,
         aes(x = fct_rev(flight_phase), y = total_injuries, 
             fill = flight_phase)) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(hjust = 1.2, size = 4.2, 
            aes(y = 0, label = comma(total_injuries))) +
  coord_polar(theta = "y") +
  labs(
    x = NULL,
    y = NULL,
    fill = "Phase of Flight",
    title = "",
    subtitle = "",
    caption = ""
  ) +
  scale_y_continuous(
    breaks = seq(0, 13200, by = 1000),
    limits = c(0, 13200)
  ) +
  scale_x_discrete(expand = c(0.35, 0)) + 
  scale_fill_manual(
    values = moma.colors("VanGogh")
  ) +
  theme(
    legend.position = "bottom",
    axis.text = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank()
    ) +
  guides(
      fill = guide_legend(
        nrow = 1,
        direction = "horizontal",
        title.position = "top",
        title.hjust = 0.5,
        label.position = "bottom",
        label.hjust = 1,
        label.vjust = 1,
        label.theme = element_text(lineheight = 0.25, size = 14),
        keywidth = 1.5,
        keyheight = 0.5
      )
    ) 

flights_radial_bar_injuries
# remaining - titles, some texts
# interactive - plotly
# animate - plotly by years or gganimate bar growth
# sources:
# gganimate - https://r-graph-gallery.com/288-animated-barplot-transition.html
# ploty - https://plotly.com/r/animations/
```

```{r hex_bin_data}
flights_ntsb_maps <- flights_ntsb |>
  subset(!is.na(longitude) & !is.na(latitude)
         & latitude < 75 & latitude > 10 & longitude < -60)

flights_ntsb_maps <- flights_ntsb_maps |>
  group_by(state, event_year) |>
  summarise(
    total_crashes = n(),
    total_injuries = sum(fatal_injury_count, na.rm = TRUE) + sum(serious_injury_count, na.rm = TRUE) + sum(minor_injury_count, na.rm = TRUE)
  ) |>
  drop_na()

unique_states <- unique(flights_ntsb_maps$state)

all_years <- unique(flights_ntsb_maps$event_year)

all_states_data <-
  expand.grid(state = unique_states, event_year = all_years)

flights_ntsb_maps_updated <-
  left_join(all_states_data,
            flights_ntsb_maps,
            by = c("state", "event_year")) |>
  mutate(
    total_crashes = ifelse(is.na(total_crashes), 0, total_crashes),
    total_injuries = ifelse(is.na(total_injuries), 0, total_injuries)
  ) |>
  filter(state %in% state.name)
```

```{r hex_bin_geometry}
shp <- read_sf(here("data", "us_states_hexgrid.shp")) |>
  mutate(google_nam = gsub(" \\(United States\\)", "", google_nam)) |>
  subset(google_nam != "District of Columbia") |>
  arrange(google_nam)

flights_ntsb_shp <- merge(shp,
                         flights_ntsb_maps_updated,
                         by.x = 'google_nam',
                         by.y = 'state')
```

```{r function_hexbin}
getHexBinMap <- function(input_year) {
  flights_ntsb_shp |>
    filter(event_year == input_year) |>
    ggplot() +
    geom_sf(aes(fill = total_crashes)) +
    geom_sf_text(aes(geometry = geometry,
                     label = iso3166_2)) +
    theme_void() +
    scale_fill_viridis_c(
      option = "plasma",
      direction = -1,
      name = "Total Number of Crashes",
      labels = scales::comma,
      guide = guide_legend(
        keyheight = unit(3, units = "mm"),
        keywidth = unit(12, units = "mm"),
        label.position = "bottom",
        title.position = "top",
        nrow = 1
      )
    ) +
    labs(title = input_year) +
    theme(legend.position = 'top')
}
```

```{r images_yearwise}
years_list <- flights_ntsb_shp |>
  arrange(event_year) |>
  distinct(event_year) |>
  pull()

my_maps <- paste0("images/hexbin_map/hex_bin_map", seq_along(years_list), ".jpg")
for (i in seq_along(years_list)){
    getHexBinMap(input_year = years_list[i])
    ggsave(my_maps[i],
           height = 8, 
           width  = 15, 
           unit   = "in", 
           dpi    = 200)
}
```

```{r animation_hexbin}
# making gif using gganimate package
hex_bin_maps <- list.files(path = "images/hexbin_map/", full.names = TRUE)
hex_bin_maps_list <- lapply(hex_bin_maps, image_read)

# joining all the saved images
joined_plots <- image_join(hex_bin_maps_list)

# animating the images using image_animate() and restting the resolution
# setting fps = 1
hex_bin_maps_animation <- image_animate(image_scale(joined_plots, "2000x1000"), fps = 1)

# saving image to git
image_write(image = hex_bin_maps_animation,
            path = "images/flight_crash_us_states.gif")
```
